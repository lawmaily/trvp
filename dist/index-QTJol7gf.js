var k=Object.defineProperty;var B=(m,n,r)=>n in m?k(m,n,{enumerable:!0,configurable:!0,writable:!0,value:r}):m[n]=r;var h=(m,n,r)=>(B(m,typeof n!="symbol"?n+"":n,r),r),L=(m,n,r)=>{if(!n.has(m))throw TypeError("Cannot "+r)};var l=(m,n,r)=>(L(m,n,"read from private field"),r?r.call(m):n.get(m)),S=(m,n,r)=>{if(n.has(m))throw TypeError("Cannot add the same private member more than once");n instanceof WeakSet?n.add(m):n.set(m,r)},_=(m,n,r,e)=>(L(m,n,"write to private field"),e?e.call(m,r):n.set(m,r),r);(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))e(t);new MutationObserver(t=>{for(const a of t)if(a.type==="childList")for(const d of a.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&e(d)}).observe(document,{childList:!0,subtree:!0});function r(t){const a={};return t.integrity&&(a.integrity=t.integrity),t.referrerPolicy&&(a.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?a.credentials="include":t.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function e(t){if(t.ep)return;t.ep=!0;const a=r(t);fetch(t.href,a)}})();class f{static async getStock(){try{const n=await fetch("http://localhost:4321/stock"),r=await n.json();return n.status!==200?Promise.reject(r):r.stock}catch(n){return Promise.reject({timestamp:new Date().toISOString(),statusCode:0,message:n.message})}}static async updateStock(n=[]){try{const r=await fetch("http://localhost:4321/stock",{method:"PATCH",body:JSON.stringify(n),headers:{"Content-Type":"application/json"}});if(r.status!==200){const e=await r.json();return Promise.reject(e)}return{timestamp:new Date().toISOString(),message:"Состав товаров на складе обновлён!"}}catch(r){return Promise.reject({timestamp:new Date().toISOString(),statusCode:0,message:r.message})}}static async getOrders(){try{const n=await fetch("http://localhost:4321/orders"),r=await n.json();return n.status!==200?Promise.reject(r):r.orders}catch(n){return Promise.reject({timestamp:new Date().toISOString(),statusCode:0,message:n.message})}}static async addOrder({order_id:n,fio:r,date_until:e,lists:t}){try{const a=await fetch("http://localhost:4321/orders",{method:"POST",body:JSON.stringify({order_id:n,fio:r,date_until:e,lists:t}),headers:{"Content-Type":"application/json"}});if(a.status!==200){const d=await a.json();return Promise.reject(d)}return{timestamp:new Date().toISOString(),message:`Заказ на имя '${r}' добавлен!`}}catch(a){return Promise.reject({timestamp:new Date().toISOString(),statusCode:0,message:a.message})}}static async updateOrder({order_id:n,fio:r,date_until:e,lists:t}){try{const a=await fetch("http://localhost:4321/orders",{method:"PATCH",body:JSON.stringify({order_id:n,fio:r,date_until:e,lists:t}),headers:{"Content-Type":"application/json"}});if(a.status!==200){const d=await a.json();return Promise.reject(d)}return{timestamp:new Date().toISOString(),message:`Заказ на имя '${r}' изменён!`}}catch(a){return Promise.reject({timestamp:new Date().toISOString(),statusCode:0,message:a.message})}}static async addList({id:n,med_name:r,count:e,order_id:t}){try{const a=await fetch("http://localhost:4321/list",{method:"POST",body:JSON.stringify({id:n,med_name:r,count:e,order_id:t}),headers:{"Content-Type":"application/json"}});if(a.status!==200){const d=await a.json();return Promise.reject(d)}return{timestamp:new Date().toISOString(),message:"Добавлена строка заказа!"}}catch(a){return Promise.reject({timestamp:new Date().toISOString(),statusCode:0,message:a.message})}}static async deleteList({id:n}){try{const r=await fetch(`http://localhost:4321/list/${n}`,{method:"DELETE"});if(r.status!==200){const e=await r.json();return Promise.reject(e)}return{timestamp:new Date().toISOString(),message:"Строка заказа удалена!"}}catch(r){return Promise.reject({timestamp:new Date().toISOString(),statusCode:0,message:r.message})}}static async deleteOrder({order_id:n}){try{const r=await fetch(`http://localhost:4321/orders/${n}`,{method:"DELETE"});if(r.status!==200){const e=await r.json();return Promise.reject(e)}return{timestamp:new Date().toISOString(),message:"Заказ удалён!"}}catch(r){return Promise.reject({timestamp:new Date().toISOString(),statusCode:0,message:r.message})}}}var v,b,C,D;class ${constructor({orderID:n,orderFIO:r,orderDate:e,orderList:t},{onEditOrder:a}){S(this,v,"");S(this,b,"");S(this,C,"");S(this,D,[]);h(this,"checkForDateDeletion",async()=>{const n=localStorage.getItem("currentDate").split(".");if(new Date(`${n[2]}-${n[1]}-${n[0]}`)>new Date(l(this,C))){if(!confirm(`Датой удаляется заказ на ${l(this,C)}`))return;await f.deleteOrder({order_id:l(this,v)}),document.location.reload()}});h(this,"sendChangesToDB",async(n,r)=>{var e=[],t=l(this,D),a=[],d,i,s,u=!1;n.lists.forEach((o,c)=>{d=t.filter((p,g)=>{if(p.listMedName==o.med_name)return s=g,!0}),d.length>0?(d=d[0],t.splice(s,1),i=d.listCount-o.count,r.filter(p=>p.name==d.listMedName)[0].count<i*-1?(alert(`Вы дополняете заказ ещё ${i*-1} экземплярами лекарства ${d.listMedName}, но на складе столько нет!`),u=!0):(n.lists[c].id=d.listID,i!==0&&e.push({name:d.listMedName,delta:i}))):(r.filter(p=>p.name==o.med_name)[0].count<o.count?(alert(`Вы дополняете заказ ещё ${o.count} экземплярами лекарства ${o.med_name}, но на складе столько нет!`),u=!0):e.push({name:o.med_name,delta:o.count*-1}),a.push(o))}),u||(t.length>0&&await Promise.all(t.map(o=>{f.deleteList({id:o.listID}),e.push({name:o.listMedName,delta:o.listCount})})),a.length>0&&await Promise.all(a.map(o=>f.addList({id:o.id,med_name:o.med_name,count:o.count,order_id:n.order_id}))),await f.updateOrder(n),await f.updateStock(e),document.location.reload())});h(this,"deleteThisOrder",async()=>{if(confirm(`Вы сейчас удалите заказ от пользователя ${l(this,b)} на ${l(this,C)}. Вы уверены?`))if(confirm("Дата передачи заказа доставщику ещё не наступила. Товары на склад от этого удаления не вернём! Вы уверены?"))await f.deleteOrder({order_id:l(this,v)}),document.location.reload();else return;else return});_(this,v,n),_(this,b,r),_(this,C,new Date(e)),_(this,D,t),this.onEditOrder=a,this.renderOrder()}get orderID(){return l(this,v)}renderList(n){l(this,D).forEach(r=>{const e=document.createElement("li");e.classList.add("medicine-list__item","medicine"),n.appendChild(e);const t=document.createElement("div");t.classList.add("medicine-desc-part-name"),e.appendChild(t);const a=document.createElement("h3");a.innerText="Название",t.appendChild(a);const d=document.createElement("span");d.innerText=r.listMedName,t.appendChild(d);const i=document.createElement("div");i.classList.add("medicine-desc-part-count"),e.appendChild(i);const s=document.createElement("h3");s.innerText="Количество",i.appendChild(s);const u=document.createElement("span");u.innerText=r.listCount,i.appendChild(u);const o=document.createElement("span");o.innerText=" шт.",i.appendChild(o)})}renderOrder(){const n=document.getElementById("creation-block-li"),r=document.createElement("li");r.classList.add("orderlist__item","order");const e=document.createElement("div");e.classList.add("order__top-block"),r.appendChild(e);const t=document.createElement("div");t.classList.add("order__user-info"),e.appendChild(t);const a=document.createElement("h3");a.innerText="Заказчик",t.appendChild(a);const d=document.createElement("span");d.innerText=l(this,b),t.appendChild(d);const i=document.createElement("button");i.type="button",i.classList.add("top-block__delete-order"),i.innerText="✖",i.name=`del-order_${l(this,v)}`,i.addEventListener("click",this.deleteThisOrder),e.appendChild(i);const s=document.createElement("button");s.type="button",s.classList.add("top-block__edit-order"),s.innerText="✎",s.name=`edit-order_${l(this,v)}`,s.addEventListener("click",()=>this.onEditOrder({orderID:l(this,v),orderUser:l(this,b),orderDate:l(this,C),medicines:l(this,D)})),e.appendChild(s);const u=document.createElement("div");u.classList.add("order__date-info"),r.appendChild(u);const o=document.createElement("h3");o.innerText="Дата",u.appendChild(o);const c=document.createElement("span");c.innerText=l(this,C).toLocaleDateString(),u.appendChild(c);const p=document.createElement("ul");p.classList.add("order__medicine-list"),r.appendChild(p),this.renderList(p),n.parentElement.insertBefore(r,n)}}v=new WeakMap,b=new WeakMap,C=new WeakMap,D=new WeakMap;var E,O;class x{constructor(){S(this,E,[]);S(this,O,[]);h(this,"showOrHideForm",n=>{n.target.checked?(document.getElementById("order-creator-form").classList.remove("hidden"),document.getElementById("creation-block-li").classList.remove("reduced-creation-block-height")):(document.getElementById("order-creator-form").classList.add("hidden"),document.getElementById("creation-block-li").classList.add("reduced-creation-block-height"))});h(this,"deleteRecipeRow",n=>{n.target.parentElement.remove();const r=document.querySelectorAll('select[name^="recipe-item"]'),e=document.querySelectorAll('button[id^="recipe-list-delete-btn"]');var t;for(t=0;t<r.length;++t)r[t].name=`recipe-item_${t}`,e[t].id=`recipe-list-delete-btn_${t}`});h(this,"renderNewRecipeRow",()=>{const n=document.getElementsByClassName("recipe-list__item").length,r=document.getElementById("recipe-add-btn"),e=document.createElement("li");e.classList.add("recipe-list__item");const t=document.createElement("select");t.classList.add("recipe-list__item-name"),t.name=`recipe-item_${n}`,t.required=!0,l(this,E).forEach(d=>{if(d.medRecipeFlag){const i=document.createElement("option");i.innerText=d.medName,t.appendChild(i)}}),e.appendChild(t);const a=document.createElement("button");a.classList.add("recipe-list-item__delete-btn"),a.type="button",a.innerText="✖",a.id=`recipe-list-delete-btn_${n}`,a.addEventListener("click",this.deleteRecipeRow),e.appendChild(a),r.parentElement.insertBefore(e,r)});h(this,"deleteListRow",n=>{n.target.parentElement.remove();const r=document.querySelectorAll('input[name^="med-ID"]'),e=document.querySelectorAll('input[name^="med-COUNT"]'),t=document.querySelectorAll('select[name^="med-NAME"]'),a=document.querySelectorAll('span[id^="med-recipe-span"]');var d;for(d=0;d<e.length;++d)r[d].name=`med-ID_${d}`,e[d].name=`med-COUNT_${d}`,t[d].name=`med-NAME_${d}`,a[d].id=`med-recipe-span_${d}`});h(this,"renderNewListRow",()=>{const n=document.querySelectorAll('span[id^="med-recipe-span"]').length,r=document.getElementById("med-list-item-add-btn"),e=document.createElement("li");e.classList.add("medicine-list__item");const t=document.createElement("input");t.type="hidden",t.value=crypto.randomUUID(),t.name=`med-ID_${n}`,e.appendChild(t);const a=document.createElement("div");a.classList.add("medicine-desc-part-name"),e.appendChild(a);const d=document.createElement("label");d.innerText="Название",a.appendChild(d);const i=document.createElement("select");i.classList.add("medicine-list__item-name"),i.name=`med-NAME_${n}`,i.required=!0,l(this,E).forEach(I=>{const y=document.createElement("option");y.innerText=I.medName,i.appendChild(y)}),i.addEventListener("change",I=>{const y=I.target.name.split("_")[1],T=l(this,E).filter(N=>N.medName==I.target.value)[0].medRecipeFlag;document.getElementById(`med-recipe-span_${y}`).innerText=T?"✔":"✖"}),a.appendChild(i);const s=document.createElement("div");s.classList.add("medicine-desc-part-count"),e.appendChild(s);const u=document.createElement("label");u.innerText="Количество",s.appendChild(u);const o=document.createElement("input");o.classList.add("form-block__input-field"),o.type="number",o.min=1,o.value=1,o.name=`med-COUNT_${n}`,s.appendChild(o);const c=document.createElement("div");c.classList.add("medicine-desc-part-recipe"),e.appendChild(c);const p=document.createElement("label");p.innerText="Требует рецепт?",c.appendChild(p);const g=document.createElement("span");g.innerText=l(this,E)[0].medRecipeFlag?"✔":"✖",g.id=`med-recipe-span_${n}`,c.appendChild(g);const w=document.createElement("button");w.classList.add("medicine-list-item__delete-btn"),w.innerText="✖",w.type="button",w.addEventListener("click",this.deleteListRow),e.appendChild(w),r.parentElement.insertBefore(e,r)});h(this,"formExecuter",async n=>{if(n.preventDefault(),!confirm("Сейчас ты собираешься отправить форму. Продолжить?"))return;const e=n.target.elements;var t,a,d=!1,i=!1,s={order_id:null,fio:null,date_until:null,lists:[]},u=[],o=[],c,p=[];for(t=0;t<e.length;++t){if(a=e[t].name,a!=="")switch(a=a.split("_"),a[0]){case"order-ID":s.order_id=e[t].value,s.order_id!=="0"&&(i=!0);break;case"order-FIO":e[t].value.split(" ").length==3?s.fio=e[t].value:(alert("ФИО должно писаться в 3 слова, разделяемые пробелами!"),d=!0);break;case"order-DATE":const g=new Date(e[t].value),w=document.getElementById("date-display").textContent.split("."),I=new Date(w[2]+"-"+w[1]+"-"+w[0]);g<I?(alert("Выбранная дата доставки заказа в прошлом! Путешествие во времени мы не изобрели..."),d=!0):s.date_until=e[t].value;break;case"recipe-item":c=l(this,E).filter(y=>y.medName==e[t].value),c.length>0&&c[0].medRecipeFlag?u.push(e[t].value):(alert("Ай-яй-яй! Какой плохой пользователь! Пожалуйста, не ломай систему!"),d=!0);break;case"med-ID":break;case"med-NAME":c=s.lists.filter(y=>y.med_name==e[t].value),c.length>0?(alert(`${e[t].value} уже есть в списке заказов. Дублировать лекарства нельзя!`),d=!0):(c=l(this,E).filter(y=>y.medName==e[t].value),c.length>0?c[0].medRecipeFlag?u.includes(c[0].medName)?(s.lists.push({id:e[t-1].value,med_name:e[t].value,count:null}),o.push({name:e[t].value,delta:null})):(alert(`Тебе нужен рецепт для заказа ${e[t].value}`),d=!0):(s.lists.push({id:crypto.randomUUID(),med_name:e[t].value,count:null}),o.push({name:e[t].value,delta:null})):(alert("Ай-яй-яй! Какой плохой пользователь! Пожалуйста, не ломай систему!"),d=!0));break;case"med-COUNT":c[0].medCount>=Number(e[t].value)?(s.lists.at(-1).count=Number(e[t].value),o.at(-1).delta=s.lists.at(-1).count*-1):i||(alert(`На складе не так много лекарства под названием "${c[0].medName}"... Сейчас там ${c[0].medCount} шт.`),d=!0),i&&(s.lists.at(-1).count=Number(e[t].value),p.push({name:c[0].medName,count:c[0].medCount}));break;default:a[0]!==""&&(alert("Ай-яй-яй! Какой плохой пользователь! Пожалуйста, не ломай систему!"),d=!0);break}if(d)break}d||(s.lists.length>0?(i?await l(this,O).filter(g=>g.orderID==s.order_id)[0].sendChangesToDB(s,p):(s.order_id=crypto.randomUUID(),await f.addOrder(s),await f.updateStock(o)),document.location.reload()):alert("Надо хотя бы что-то в заказ включить..."))});h(this,"formCleaner",()=>{document.querySelector('h2[class="form-label"]').innerText="Создание заказа",document.querySelector("input[name=order-ID]").value="0",document.querySelector("input[name=order-FIO]").value="",document.querySelector("input[name=order-DATE]").value="";const n=document.querySelector(".form-block__recipe-list");for(;n.firstChild.tagName!=="BUTTON";)n.firstChild.remove();const r=document.querySelector(".form-block__medicine-list");for(;r.firstChild.tagName!=="BUTTON";)r.firstChild.remove()});h(this,"onEditOrder",({orderID:n,orderUser:r,orderDate:e,medicines:t})=>{this.formCleaner(),document.querySelector('h2[class="form-label"]').innerText="ИЗМЕНЕНИЕ заказа",document.querySelector('input[name="order-ID"]').value=n,document.querySelector('input[name="order-FIO"]').value=r;const a=new Date(e);document.querySelector('input[name="order-DATE"]').value=`${a.getFullYear()}-${a.getMonth()+1<10?0:""}${a.getMonth()+1}-${a.getDate()<10?0:""}${a.getDate()}`,alert("Загляните в форму создания заказа, она чуть изменилась OwO. Кнопка сброса вернёт форму к созданию!");var d=[];t.map(g=>d.push(g.listMedName));const i=document.getElementById("recipe-add-btn");var s;const u=document.getElementById("med-list-item-add-btn");var o,c,p;for(c=0,p=0;c<t.length;++c,++p)i.click(),o=document.querySelector(`select[name="recipe-item_${p}"]`),o.value=t[c].listMedName,o.value||(s=document.getElementById(`recipe-list-delete-btn_${p}`),s.click(),p-=1),u.click(),document.querySelector(`select[name="med-NAME_${c}"]`).value=t[c].listMedName,document.querySelector(`input[name="med-COUNT_${c}"]`).value=t[c].listCount,document.querySelector(`select[name="med-NAME_${c}"]`).dispatchEvent(new Event("change"))});h(this,"redrawTable",n=>{const r=document.querySelector(".stock-table");var e;for(e=1;e<r.rows.length;++e)r.rows[e].cells[0].innerText=l(this,E)[e-1].medName,r.rows[e].cells[1].innerText=`${l(this,E)[e-1].medCount} шт.`,r.rows[e].cells[2].innerText=`+${n[e-1].delta}`});h(this,"onPushHeaderDate",async n=>{const r=localStorage.getItem("currentDate").split(".");var e=new Date(`${r[2]}-${r[1]}-${r[0]}`);if(e.setDate(e.getDate()+n),document.getElementById("date-display").innerText=e.toLocaleDateString(),localStorage.setItem("currentDate",e.toLocaleDateString()),n>0){await Promise.all(l(this,O).map(a=>a.checkForDateDeletion()));var t=[];l(this,E).map(a=>t.push({name:a.medName,delta:Math.floor(Math.random()*3)})),await f.updateStock(t),_(this,E,await f.getStock()),this.redrawTable(t)}});h(this,"renderStockTable",()=>{const n=document.querySelector('ul[class="orderlist"]'),r=document.createElement("table");r.classList.add("stock-table");const e=document.createElement("tr");e.classList.add("stock-table__head-row"),r.appendChild(e);const t=document.createElement("th");t.innerText="Название лекарства",e.appendChild(t);const a=document.createElement("th");a.innerText="Количество",e.appendChild(a);const d=document.createElement("th");d.innerText="Поставка",e.appendChild(d),l(this,E).forEach(i=>{const s=document.createElement("tr");s.classList.add("stock-table__common-row"),r.appendChild(s);const u=document.createElement("td");u.innerText=i.medName,s.appendChild(u);const o=document.createElement("td");o.innerText=`${i.medCount} шт.`,s.appendChild(o);const c=document.createElement("td");c.innerText="+0",s.appendChild(c)}),n.parentElement.insertBefore(r,n)})}async init(){const n=localStorage.getItem("currentDate")!==null?localStorage.getItem("currentDate"):"01.02.2024";localStorage.setItem("currentDate",n),document.getElementById("date-display").innerText=n,document.getElementById("date-forwards-btn").addEventListener("click",()=>this.onPushHeaderDate(1)),document.getElementById("date-backwards-btn").addEventListener("click",()=>this.onPushHeaderDate(-1)),document.getElementById("form-visible-switch").addEventListener("change",this.showOrHideForm),document.getElementById("order-creator-form").addEventListener("submit",this.formExecuter),document.getElementById("recipe-add-btn").addEventListener("click",this.renderNewRecipeRow),document.getElementById("med-list-item-add-btn").addEventListener("click",this.renderNewListRow),document.getElementById("order-FORM-RESET").addEventListener("click",this.formCleaner);try{_(this,E,await f.getStock()),(await f.getOrders()).forEach(t=>l(this,O).push(new $(t,{onEditOrder:this.onEditOrder})))}catch(e){console.error(e)}this.renderStockTable()}}E=new WeakMap,O=new WeakMap;document.addEventListener("DOMContentLoaded",()=>{new x().init()});
